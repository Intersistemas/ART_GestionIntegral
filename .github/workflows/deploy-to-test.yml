name: Deploy to Test

on:
  push:
    branches:
      - release/**

  workflow_dispatch:
    inputs:
      reason:
        description: 'Deploy manual'
        required: true
        default: 'Deploy manual'

jobs:
  build-and-deploy:
    name: Build and deploy on self-hosted Windows runner
    runs-on: [self-hosted, windows, x64, art-front-test]
    env:
      # --- CORRECCIÓN DE RUTAS PARA PM2 ---
      HOMEDRIVE: "C:"
      HOMEPATH: '\Users\Administrador'
      USERPROFILE: 'C:\Users\Administrador'
      PM2_PATH: 'C:\Users\Administrador\AppData\Roaming\npm\pm2.ps1'
      # ------------------------------------
      SITE_PATH: ${{ secrets.SITE_PATH }}
      SITE_NAME: ${{ secrets.SITE_NAME }}
      BACKUP_PATH: ${{ secrets.BACKUP_PATH }}
      MAX_BACKUPS: ${{ secrets.MAX_BACKUPS }}
      TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
      REPO: ${{ github.repository }}
      BRANCH: ${{ github.ref_name }}
      RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      COMMIT: ${{ github.sha }}
      ACTOR: ${{ github.actor }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Notify Teams - Start
        if: ${{ env.TEAMS_WEBHOOK_URL != '' }}
        shell: powershell
        run: |
          $webhook = $env:TEAMS_WEBHOOK_URL
          if ([string]::IsNullOrEmpty($webhook)) { Write-Host "No Teams webhook configured - skipping"; exit 0 }
          $msg = "**Deployment started**`nRepository: $env:REPO`nBranch: $env:BRANCH`nCommit: $env:COMMIT`nActor: $env:ACTOR`nRun: $env:RUN_URL"
          $body = @{ text = $msg } | ConvertTo-Json
          Invoke-RestMethod -Uri $webhook -Method Post -Body $body -ContentType 'application/json'

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Show node/npm versions and timestamp
        shell: powershell
        run: |
          Write-Host "Node version:"; node -v
          Write-Host "NPM version:"; npm -v
          Write-Host "Timestamp:"; Get-Date

      - name: Cache npm registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (verbose, save log)
        shell: powershell
        timeout-minutes: 45
        run: |
          cmd /c "npm ci --verbose > npmci_verbose.log 2>&1"

      - name: Upload npm ci verbose log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npmci-verbose-log
          path: npmci_verbose.log

      - name: Build
        run: |
          npm run build

      - name: Backup current deployment
        shell: powershell
        run: |
          if ([string]::IsNullOrEmpty($env:SITE_PATH)) { $DEPLOY_DIR = 'C:\inetpub\sitios\ArtFrontGestionIntegral' } else { $DEPLOY_DIR = $env:SITE_PATH }
          if (-not (Test-Path $DEPLOY_DIR)) { Write-Host "No existing deploy dir: $DEPLOY_DIR - skipping backup"; return }

          if ([string]::IsNullOrEmpty($env:BACKUP_PATH)) { $BACKUP_DIR = Join-Path $DEPLOY_DIR 'backups' } else { $BACKUP_DIR = $env:BACKUP_PATH }
          New-Item -ItemType Directory -Force -Path $BACKUP_DIR | Out-Null

          $timestamp = Get-Date -Format "yyyyMMddHHmmss"
          $temp = Join-Path $env:TEMP ("deploy_backup_$timestamp")
          New-Item -ItemType Directory -Force -Path $temp | Out-Null

          # Mirror current deployment to temp
          $robolog = Join-Path (Get-Location) ("robocopy_backup_$timestamp.log")
          robocopy $DEPLOY_DIR $temp /MIR /XD .git .github workflows node_modules backups /LOG:$robolog /TEE
          
          # Zip the backup
          $backupFile = Join-Path $BACKUP_DIR ("backup_$timestamp.zip")
          Compress-Archive -Path (Join-Path $temp '*') -DestinationPath $backupFile -Force

          # Remove temp folder
          Remove-Item -Recurse -Force $temp

          # Retention policy
          if ([string]::IsNullOrEmpty($env:MAX_BACKUPS)) { $max = 5 } else { $max = [int]$env:MAX_BACKUPS }
          $backups = Get-ChildItem -Path $BACKUP_DIR -Filter '*.zip' | Sort-Object LastWriteTime -Descending
          if ($backups.Count -gt $max) {
            $backups | Select-Object -Skip $max | ForEach-Object { Remove-Item $_.FullName -Force }
          }

      - name: Copy build to deployment directory (Windows)
        shell: powershell
        run: |
          if ([string]::IsNullOrEmpty($env:SITE_PATH)) { $DEPLOY_DIR = 'C:\inetpub\sitios\ArtFrontGestionIntegral' } else { $DEPLOY_DIR = $env:SITE_PATH }
          New-Item -ItemType Directory -Force -Path $DEPLOY_DIR | Out-Null
          
          $robolog2 = Join-Path (Get-Location) 'robocopy_deploy.log'
          robocopy . $DEPLOY_DIR /MIR /XD .git .github node_modules /XF .env web.config server.js /LOG:$robolog2 /TEE
          if ($LASTEXITCODE -gt 3) { throw "robocopy failed with code $LASTEXITCODE" }

      - name: Install production dependencies on deploy dir (Windows)
        shell: powershell
        run: |
          if ([string]::IsNullOrEmpty($env:SITE_PATH)) { $DEPLOY_DIR = 'C:\inetpub\sitios\ArtFrontGestionIntegral' } else { $DEPLOY_DIR = $env:SITE_PATH }
          Set-Location -Path $DEPLOY_DIR
          npm ci --omit=dev

      - name: Ensure PM2 is installed (Windows)
        shell: powershell
        run: |
          if (-not (Test-Path $env:PM2_PATH)) {
            npm install -g pm2
          }

      - name: Start/Reload application with PM2 (Windows)
        shell: powershell
        run: |
          if ([string]::IsNullOrEmpty($env:SITE_PATH)) { $DEPLOY_DIR = 'C:\inetpub\sitios\ArtFrontGestionIntegral' } else { $DEPLOY_DIR = $env:SITE_PATH }
          Set-Location -Path $DEPLOY_DIR

          $appName = if ([string]::IsNullOrEmpty($env:SITE_NAME)) { 'ArtFrontGestionIntegral' } else { $env:SITE_NAME }
          
          # Ejecución usando la ruta absoluta forzada del script de PM2
          & $env:PM2_PATH delete $appName -s | Out-Null
          & $env:PM2_PATH start ecosystem.config.js
          
          if ($LASTEXITCODE -ne 0) {
             & $env:PM2_PATH start ecosystem.config.js --env production
          }

      - name: Save PM2 process list (Windows)
        shell: powershell
        run: |
          & $env:PM2_PATH save

      - name: Show PM2 status (Windows)
        shell: powershell
        run: |
          & $env:PM2_PATH status

      - name: Notify Teams - Finish
        if: always() && env.TEAMS_WEBHOOK_URL != ''
        shell: powershell
        run: |
          $webhook = $env:TEAMS_WEBHOOK_URL
          $conclusion = '${{ job.status }}'
          $msg = "**Deployment finished**`nRepository: $env:REPO`nBranch: $env:BRANCH`nResult: $conclusion`nRun: $env:RUN_URL"
          $body = @{ text = $msg } | ConvertTo-Json
          Invoke-RestMethod -Uri $webhook -Method Post -Body $body -ContentType 'application/json'
